!/usr/bin/env python3
"""
*****************************COPYRIGHT******************************
 (C) Crown copyright 2020-2025 Met Office. All rights reserved.

 Use, duplication or disclosure of this code is subject to the restrictions
 as set forth in the licence. If no licence has been raised with this copy
 of the code, the use, duplication or disclosure of it is strictly
 prohibited. Permission to do so must first be obtained in writing from the
 Met Office Information Asset Owner at the following address:

 Met Office, FitzRoy Road, Exeter, Devon, EX1 3PB, United Kingdom
*****************************COPYRIGHT******************************

NAME
    launch_rose_stem

DESCRIPTION
    Script to rose test suites using a launcher rose suite.

    The script expects the following environment variables:

      TESTDIR    - file path to a directory where the suite source code
                   can be extracted
      SUITE_URL  - The URL of the suite rose bush page
      SUITE_REV  - The revision number of the suite
      SUITE_NAME - The name of the suite being launched
      HEADER_MSG - (optional) A message to be displayed when launching the suite
      ADD_OPTS   - (optional) A a list of argument to be passed to the
                   rose suite-run command. The list should be specified as a
                   python format list of tuples.
                   For example: [('a',1),('b',2)]. You can check whether you
                   have a valid string by running the command
                   dict(eval(add_opts)). If a dictionary is successfully created,
                   then the format is correct.
"""

import os
import sys
import subprocess
import datetime
import shutil

def main():
    """
    Main function for launching nightly test suite.
    """
    # see module docstring for more info on list of options
    test_dir = os.environ['TESTDIR']
    suite_url = os.environ['SUITE_URL']
    suite_rev = os.environ['SUITE_REV']
    suite_name = os.environ['SUITE_NAME']
    suite_local_dir = os.path.join(test_dir, suite_name)
    header_msg = os.environ.get('HEADER_MSG', '')
    try:
        # see module docstring for details on expected format
        add_opts_raw = eval(os.environ['ADD_OPTS'])
    except KeyError:
        add_opts_raw = []
    except SyntaxError:
        add_opts_raw = []

    #check that the resulting add_opts is in the expected format
    add_opts = []
    for t1 in add_opts_raw:
        try:
            if len(t1) == 2:
                add_opts += [(t1[0], t1[1])]
        # deliberately catching all exceptions, so that we can move on to
        # the next list item if there's any issue
        except:
            pass



    msg1 = '{msg} test suite script {datetime}'
    msg1 = msg1.format(msg=header_msg,
                       datetime=str(datetime.datetime.now()))
    sys.stdout.write(msg1)
    sys.stdout.flush()

    # remove anything that exists at this location
    if os.path.exists(suite_local_dir):
        sys.stdout.write('removing existing item at {0}'.
                         format(suite_local_dir))
        sys.stdout.flush()
        if os.path.isdir(suite_local_dir):
            shutil.rmtree(suite_local_dir)
        else:
            os.remove(suite_local_dir)

    #checkout the suite
    checkout_cmd = 'fcm co {url}@{rev} {ldir} -q'
    checkout_cmd = checkout_cmd.format(url=suite_url,
                                       rev=suite_rev,
                                       ldir=suite_local_dir)
    sys.stdout.write('Extracting moci test suite with cmd: {0}'.
                     format(checkout_cmd))
    sys.stdout.flush()
    subprocess.call(checkout_cmd,
                    shell=True)

    os.chdir(suite_local_dir)

    suite_run_cmd = 'rose suite-run --name={0} --new  --no-gcontrol '
    for opt1, value1 in add_opts:
        suite_run_cmd += ' --{opt}={val} '.format(opt=opt1,
                                                  val=value1)
    suite_run_cmd = suite_run_cmd.format(suite_name)

    sys.stdout.write('Launching moci test suite')
    sys.stdout.write('command: {0}'.format(suite_run_cmd))
    sys.stdout.flush()
    rcode = subprocess.call(suite_run_cmd, shell=True)
    if rcode != 0:
        #The suite has failed to launch correctly
        sys.stderr.write('The suite {0} has failed to launch, please see'
                         ' output above for more details\n'.
                         format(suite_name))
        sys.exit(rcode)

if __name__ == '__main__':
    main()
